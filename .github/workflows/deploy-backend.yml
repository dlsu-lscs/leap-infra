---
name: Deploy Backend

on:
  repository_dispatch:
    types: [backend-update]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout infrastructure
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.32.2"

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.6.0"

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event.client_payload.branch }}" == "main" ]; then
            echo "name=production" >> $GITHUB_OUTPUT
            echo "prefix=" >> $GITHUB_OUTPUT
          else
            echo "name=staging" >> $GITHUB_OUTPUT
            echo "prefix=staging-" >> $GITHUB_OUTPUT
          fi
          echo "Environment: ${{ steps.env.outputs.name }}"
          echo "Prefix: ${{ steps.env.outputs.prefix }}"

      # Handle migrations if needed
      - name: Download migrations
        if: github.event.client_payload.has_migrations == true
        uses: dawidd6/action-download-artifact@v9
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: build-push-deploy.yml
          name: migrations-${{ github.event.client_payload.commit_sha }}
          repo: dlsu-lscs/leap25-backend
          path: migrations-archive
          check_artifacts: true
          search_artifacts: true

      - name: Extract migrations
        if: github.event.client_payload.has_migrations == true
        run: |
          mkdir -p temp-migrations/migrations
          tar -xzf migrations-archive/migrations.tar.gz -C temp-migrations/ || {
            echo "Failed to extract migrations archive"
            exit 1
          }
          echo "Migrations extracted successfully"
          ls -la temp-migrations/migrations/

      - name: Update backend image reference
        run: |
          echo "Updating backend image reference for ${{ steps.env.outputs.name }} to ${{ github.event.client_payload.image }}"
          cd overlays/${{ steps.env.outputs.name }}/backend
          kustomize edit set image ghcr.io/dlsu-lscs/leap25-backend=${{ github.event.client_payload.image }}
          cd ../../../

      - name: Apply migrations
        if: github.event.client_payload.has_migrations == true
        id: migrations
        timeout-minutes: 5
        run: |
          set -e
          echo "Applying migrations for ${{ steps.env.outputs.name }} environment"

          # Create a temporary kustomization file for migrations
          cat <<EOF > temp-migrations/kustomization.yaml
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
          - ../base/migrations
          namePrefix: ${{ steps.env.outputs.prefix }}
          images:
          - name: ghcr.io/dlsu-lscs/leap25-backend
            newName: ghcr.io/dlsu-lscs/leap25-backend
            newTag: sha-${{ github.event.client_payload.commit_sha }}
          EOF

          echo "Applying migration job..."
          kubectl apply -k temp-migrations/

          JOB_NAME="${{ steps.env.outputs.prefix }}leap25-db-migration"
          echo "Migration job name: $JOB_NAME"

          echo "Waiting for migration job completion..."
          kubectl wait --for=condition=complete job/$JOB_NAME --timeout=180s

          if [ $? -ne 0 ]; then
            echo "Migration job failed or timed out"
            kubectl logs job/$JOB_NAME
            exit 1
          fi

          echo "Migrations completed successfully"
          kubectl logs job/$JOB_NAME

      - name: Deploy backend application
        timeout-minutes: 5
        run: |
          echo "Deploying backend to ${{ steps.env.outputs.name }} environment"

          # apply updated backend deployment
          kubectl apply -k overlays/${{ steps.env.outputs.name }}/backend

          echo "Waiting for deployment rollout..."
          kubectl rollout status deployment/${{ steps.env.outputs.prefix }}leap25-backend --timeout=300s

          echo "Backend deployment completed successfully"

      - name: Cleanup migration job
        if: always() && github.event.client_payload.has_migrations == true
        continue-on-error: true
        run: |
          echo "Cleaning up migration job..."
          kubectl delete job/${{ steps.env.outputs.prefix }}leap25-db-migration
          rm -rf temp-migrations

      - name: Notify deployment success
        if: success()
        run: |
          echo "Backend deployment to ${{ steps.env.outputs.name }} completed successfully"
          # add notification integration (Slack, Teams, etc.)

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "Backend deployment to ${{ steps.env.outputs.name }} failed"
          # add notification integration (Slack, Teams, etc.)
